<script setup lang="ts">
import { useDataStore } from '@/stores/data'
import { ref, watch } from 'vue'
// @ts-ignore
import VueApexCharts, { type VueApexChartsComponent } from 'vue3-apexcharts'
import { PulseLoader } from 'vue-spinner/dist/vue-spinner.min.js'

const dataStore = useDataStore()

const chart = ref<VueApexChartsComponent | null>(null)

const less_then_10 = ref(dataStore.less_then_10)
const bt_10_15 = ref(dataStore.bt_10_15)
const bt_15_20 = ref(dataStore.bt_15_20)
const bt_20_25 = ref(dataStore.bt_20_25)
const bt_25_30 = ref(dataStore.bt_25_30)
const bt_30_45 = ref(dataStore.bt_30_45)
const bt_45_60 = ref(dataStore.bt_45_60)
const more_then_60 = ref(dataStore.more_then_60)

const chartSeries = ref([
  {
    name: 'Data',
    data: [
      less_then_10.value,
      bt_10_15.value,
      bt_15_20.value,
      bt_20_25.value,
      bt_25_30.value,
      bt_30_45.value,
      bt_45_60.value,
      more_then_60.value
    ]
  }
])

const chartOptions = ref({
  chart: {
    type: 'bar',
    height: 300,
    width: 800
  },
  plotOptions: {
    bar: {
      borderRadius: 4,
      horizontal: true,
      dataLabels: {
        position: 'top' // Display data labels at the end of the bars
      }
    }
  },
  dataLabels: {
    enabled: true,
    offsetX: 25,
    style: {
      fontSize: '12px',
      colors: ['#000']
    },
    formatter: function (val: number) {
      return val > 0 ? val.toString() + '%' : ''
    }
  },
  xaxis: {
    categories: [
      'Less than 10 minutes',
      '10 – 15 minutes',
      '16 – 20 minutes',
      '21 – 25 minutes',
      '26 – 30 minutes',
      '31 – 45 minutes',
      '46 – 60 minutes',
      'More than 60 minutes'
    ],
    show: false,
    labels: {
      formatter: function () {
        return ''
      }
    }
  },
  yaxis: {
    title: {
      text: ''
    }
  },
  responsive: [
    {
      breakpoint: 980,
      options: {
        chart: {
          width: '700px'
        }
      }
    },
    {
      breakpoint: 700,
      options: {
        chart: {
          width: '600px'
        }
      }
    },
    {
      breakpoint: 640,
      options: {
        chart: {
          width: '500px'
        }
      }
    },
    {
      breakpoint: 540,
      options: {
        chart: {
          width: '400px'
        }
      }
    },
    {
      breakpoint: 1280,
      options: {
        chart: {
          width: '900px'
        }
      }
    },
    {
      breakpoint: 1024,
      options: {
        chart: {
          width: '900px'
        }
      }
    },
    {
      breakpoint: 1441,
      options: {
        chart: {
          width: '400px'
        }
      }
    },
    {
      breakpoint: 1530,
      options: {
        chart: {
          width: '450px'
        }
      }
    },
    {
      breakpoint: 1650,
      options: {
        chart: {
          width: '450px'
        }
      }
    },
    {
      breakpoint: 1170,
      options: {
        chart: {
          width: '700px'
        }
      }
    },
    {
      breakpoint: 2160,
      options: {
        chart: {
          width: '520px'
        }
      }
    },
    {
      breakpoint: 769,
      options: {
        chart: {
          width: '650px'
        }
      }
    },
    {
      breakpoint: 480,
      options: {
        chart: {
          width: '100%'
        }
      }
    }
  ]
})

watch(
  () => [
    dataStore.less_then_10,
    dataStore.bt_10_15,
    dataStore.bt_15_20,
    dataStore.bt_20_25,
    dataStore.bt_25_30,
    dataStore.bt_30_45,
    dataStore.bt_45_60,
    dataStore.more_then_60
  ],
  (newValues) => {
    chartSeries.value[0].data = newValues
    if (chart.value) {
      chart.value.updateSeries(chartSeries.value, true)
    }
  }
)

// const updateBarChart = () => {
//   const timeIntervals = {
//     'Less than 10 minutes': dataStore.less_then_10,
//     '10 – 15 minutes': dataStore.bt_10_15,
//     '16 – 20 minutes': dataStore.bt_15_20,
//     '21 – 25 minutes': dataStore.bt_20_25,
//     '26 – 30 minutes': dataStore.bt_25_30,
//     '31 – 45 minutes': dataStore.bt_30_45,
//     '46 – 60 minutes': dataStore.bt_45_60,
//     'More than 60 minutes': dataStore.more_then_60
//   }

//   // Filter out intervals with zero values
//   const filteredIntervals = Object.entries(timeIntervals).filter(([key, value]) => value > 0)

//   // Update the chart series and categories
//   chartSeries.value[0].data = filteredIntervals.map(([key, value]) => value)
//   chartOptions.value.xaxis.categories = filteredIntervals.map(([key]) => key)

//   if (chart.value) {
//     chart.value.updateSeries(chartSeries.value, true)
//   }
// }

// watch(
//   () => [
//     dataStore.less_then_10,
//     dataStore.bt_10_15,
//     dataStore.bt_15_20,
//     dataStore.bt_20_25,
//     dataStore.bt_25_30,
//     dataStore.bt_30_45,
//     dataStore.bt_45_60,
//     dataStore.more_then_60
//   ],
//   () => {
//     updateBarChart()
//   }
// )
</script>

<template>
  <div
    class="relative p-5 col-span-12 rounded-lg border border-stroke bg-white px-5 pt-7.5 pb-5 shadow-[1px_2px_55px_-18px_#00008070] dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:col-span-5"
  >
    <div class="mb-3 justify-center gap-4 sm:flex">
      <div>
        <h4 class="text-[19.5px] text-center font-extrabold text-black dark:text-white mt-4">
          Turnaround Time of Purpose of Visit
        </h4>
      </div>
    </div>

    <div
      class="mb-2"
      v-if="
        dataStore.bt_10_15 > 0 ||
        dataStore.bt_15_20 > 0 ||
        dataStore.bt_20_25 > 0 ||
        dataStore.bt_25_30 > 0 ||
        dataStore.bt_30_45 > 0 ||
        dataStore.bt_45_60 > 0 ||
        dataStore.more_then_60 > 0
      "
    >
      <div id="TreeMap" class="mx-auto flex justify-center mt-5">
        <VueApexCharts
          type="bar"
          height="400"
          :options="chartOptions"
          :series="chartSeries"
          ref="chart"
        />
      </div>
      <span class="ml-4 font-bold text-[14px] text-black/40 float-right">
        n={{ useDataStore().achieved }}
      </span>
    </div>
    <div
      v-else
      class="absolute left-[32%] top-[50%] text-center font-extrabold text-black dark:text-white mb-8"
    >
      <div v-if="!useDataStore().loader" class="ml-20 mt-5">
        <pulse-loader :color="useDataStore().color" :size="useDataStore().size"></pulse-loader>
      </div>
      <div v-else class="mt-5 ml-26 text-xl">No Data</div>
    </div>
  </div>
</template>

<style>
/* Add any styles for the component here */
#TreeMap {
  width: 100%;
}
</style>
